{% extends "base.html" %}
{% load static %}

{% block extrahead %}
    <link rel="manifest" href="/manifest.json" />
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
    <script>
      var OneSignal = window.OneSignal || [];
      OneSignal.push(['init', {
        appId: "f36145bc-6ad0-4855-b36b-c1aa5aa99ccb",
        autoRegister: false,
        notifyButton: {
          enable: false,
        },
        httpPermissionRequest: {
          enable: true
        },
        welcomeNotification: {
          "title": "TheaterWecker",
          "message": "Herzlich Willkommen beim TheaterWecker",
          // "url": "" /* Leave commented for the notification to not open a window on Chrome and Firefox (on Safari, it opens to your webpage) */
        },
        promptOptions: {
          /* Change bold title, limited to 30 characters */
          siteName: 'TheaterWecker',
          /* Subtitle, limited to 90 characters */
          actionMessage: "Möchtest du, dass der TheaterWecker dich benachticht?",
          /* Example notification title */
          exampleNotificationTitle: "Es gibt noch Karten für 'BEATE UWE UWE SELFIE KLICK'",
          /* Example notification message */
          exampleNotificationMessage: 'Eine europäische Groteske (Uraufführung)',
          /* Accept button text, limited to 15 characters */
          acceptButtonText: "Erlauben",
          /* Cancel button text, limited to 15 characters */
          cancelButtonText: "Nein Danke!"
        }
      }]);
    </script>
{% endblock %}
{% block extrascript %}
    <script>
    function updateEventSubscription() {
      getSubscriptionState().then(function(state) {
        if (state.isPushEnabled && !state.isOptedOut) {
          OneSignal.getUserId().then((userid) => {
            document.querySelector('input[name="email"]').value = '';
            document.querySelector('input[name="device"]').value = userid;
            return Promise.resolve();
          })
          .then(() => {
            document.querySelector('#subscribe-form').submit();
          });
        }
      });
    }
    
    function subscribe(event) {
      getSubscriptionState()
        .then(function(state) {
          if (!state.isPushEnabled) {
            if (state.isOptedOut) {
              /* Opted out, opt them back in */
               OneSignal.setSubscription(true);
            } else {
               /* Unsubscribed, subscribe them */
               OneSignal.registerForPushNotifications();
            }
          }
          return Promise.resolve();
        })
        .then(updateEventSubscription);
      event.preventDefault();
    }

    function getSubscriptionState() {
      return Promise.all([
        OneSignal.isPushNotificationsEnabled(),
        OneSignal.isOptedOut(),
      ])
        .then(function([isPushEnabled, isOptedOut]) {
          return {
            isPushEnabled,
            isOptedOut,
          };
        });
    }

    /* This example assumes you've already initialized OneSignal */
    OneSignal.push(function() {
      // If we're on an unsupported browser, do nothing
      if (!OneSignal.isPushNotificationsSupported()) {
        return;
      }
      OneSignal.on("subscriptionChange", function(isSubscribed) {
        /* If the user's subscription state changes during the page's session, update the button text */
        updateEventSubscription();
      });
    });

    const subscribeButton = document.querySelector("#subscribe-button");
    subscribeButton.addEventListener('click', subscribe, true)
</script>
{% endblock %}

{% block content %}
<h1><img class="logo" src="{% static 'img/performing-arts.svg' %}"><img class="logo" src="{% static 'img/alarm-clock.svg' %}"> &nbsp; TheaterWecker</h1>
<div>
<p>
  Wusstest du, dass du als Chemnitzer Student mit deinem <strong>Studentenausweis</strong> 15 Minuten vor Beginn einer Theatervorstellung <strong>kostenlos</strong> rein kommst, wenn noch Tickets vorhanden sind? <span class="cite">*</span>
</p>
<p>
  Lass dich einfach von uns benachrichtigen, wenn kurz vor der Veranstaltung noch Tickets frei sind.
</p>
<p>
  Jetzt auch als Android App.
  <a href="https://play.google.com/store/apps/details?id=de.codeforchemnitz.theaterwecker"><img class="google_play_badge" src="{% static 'img/google-play-badge.png' %}"></a>
</p>
<div class="horizontal"></div>
<form action="{% url 'app:subscribe' %}" method="post" id="subscribe-form">
  <p>Benachrichtige mich</p>
  <div class="button-group">
    <input type="radio" name="interval" id="interval2" value="00:30:00">
    <label class="button" for="interval2">30 Minuten</label>
    <input type="radio" name="interval" id="interval3" value="01:00:00">
    <label class="button" for="interval3">1 Stunde</label>
    <input type="radio" name="interval" id="interval4" value="02:00:00">
    <label class="button" for="interval4">2 Stunden</label>
    <input type="radio" name="interval" id="interval5" value="04:00:00">
    <label class="button" for="interval5">4 Stunden</label>
  </div>

  <p>vor Beginn der Veranstaltung – sofern noch Plätze frei sind – für</p>

  <div class="button-group">
    {% for category in categories %}
      <input type="checkbox" name="categories" id="category{{ category.id }}" value="{{ category.pk }}">
      <label class="button" for="category{{ category.pk }}">{{ category.name }}</label>
    {% endfor %}
  </div>
<div style="display: flex; justify-content: space-evenly; flex-wrap: wrap">
  <div style="padding: 0 .5rem">
    <p>via E-Mail</p>

    <div class="button-group">
      <input class="button" type="email" name="email" placeholder="max@mustermann.de" required>
    </div>

    <div class="button-group">
      <input class="button" type="submit" value="Abonnieren">
    </div>
  </div>
  <div style="padding: 0 .5rem">
    <p>via Web-Push</p>

    <input type="hidden" name="device">
    <div class="button-group" style="margin-top: -1px">
      <input class="button" type="submit" value="Abonnieren" id="subscribe-button">
    </div>
  </div>
</div>
  {% csrf_token %}
</form>

</div>
{% endblock %}

{% block footnote %}
<div class="footnote">
  * Dies ist mit dem <a href="https://www.tu-chemnitz.de/stura/de/kulturticket">Kulturticket</a> deines Studentenausweises möglich.
</div>
{% endblock %}
